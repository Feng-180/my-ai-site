<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI åŠ©æ‰‹</title>
    <style>
        /* æ ·å¼éƒ¨åˆ† */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #1a1a1a; color: #fff; display: flex; justify-content: center; height: 100vh; overflow: hidden; /* é˜²æ­¢æ•´ä½“æ»šåŠ¨ */ }
        .app { width: 100%; max-width: 800px; display: flex; flex-direction: column; background: #2d2d2d; height: 100%; position: relative; }
        
        .header { 
            padding: 15px; 
            border-bottom: 1px solid #444; 
            text-align: center; 
            font-weight: bold; 
            background: #202020; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }
        .header span { font-size: 18px; }
        .reset-btn { font-size: 14px; color: #888; cursor: pointer; text-decoration: underline; padding: 5px; }
        
        .chat-box { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch; /* iOS æ»šåŠ¨ä¼˜åŒ– */
        }
        
        .msg { display: flex; gap: 10px; max-width: 85%; animation: fadeIn 0.3s ease; }
        .msg.user { align-self: flex-end; flex-direction: row-reverse; }
        .avatar { font-size: 20px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #444; border-radius: 50%; flex-shrink: 0; }
        .msg.user .avatar { background: #4caf50; }
        
        .bubble { padding: 12px 16px; border-radius: 12px; line-height: 1.5; word-wrap: break-word; font-size: 16px; }
        .msg.user .bubble { background: #4caf50; color: #fff; border-top-right-radius: 2px; }
        .msg.ai .bubble { background: #3d3d3d; color: #e0e0e0; border-top-left-radius: 2px; }
        
        .input-area { 
            padding: 15px; 
            background: #202020; 
            border-top: 1px solid #444; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            /* é€‚é… iPhone åº•éƒ¨å°é»‘æ¡ */
            padding-bottom: max(15px, env(safe-area-inset-bottom)); 
            flex-shrink: 0; 
        }
        
        #api-key-container { display: none; }
        
        /* æ ¸å¿ƒä¿®å¤ 2ï¼šæ‰€æœ‰è¾“å…¥æ¡†å­—ä½“å¼ºåˆ¶è®¾ä¸º 16pxï¼Œé˜²æ­¢ iOS è‡ªåŠ¨æ”¾å¤§ */
        input, textarea, select { 
            font-size: 16px !important; 
        }

        #api-key { 
            background: #1a1a1a; 
            border: 1px solid #555; 
            color: #aaa; 
            padding: 10px; 
            border-radius: 5px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        
        .input-group { display: flex; gap: 10px; align-items: center; }
        
        textarea { 
            flex: 1; 
            background: #333; 
            border: 1px solid #555; 
            color: #fff; 
            padding: 10px 12px; 
            border-radius: 20px; 
            outline: none; 
            resize: none; 
            height: 24px; 
            line-height: 24px;
            max-height: 100px;
        }
        
        button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 0 20px; 
            height: 44px; /* åŠ å¤§æŒ‰é’®é«˜åº¦ï¼Œæ–¹ä¾¿ç‚¹å‡» */
            border-radius: 22px; 
            font-weight: bold; 
            cursor: pointer; 
            white-space: nowrap; 
            font-size: 16px; 
        }
        button:disabled { background: #555; opacity: 0.7; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <span>ğŸ”® AI åŠ©æ‰‹</span>
        <span class="reset-btn" onclick="resetKey()">é‡ç½®Key</span>
    </div>
    
    <div class="chat-box" id="chat-box">
        <div class="msg ai">
            <div class="avatar">ğŸ¤–</div>
            <div class="bubble">ä½ å¥½ï¼æˆ‘å·²ç»å‡†å¤‡å¥½å’Œä½ èŠå¤©äº†ã€‚</div>
        </div>
    </div>

    <div class="input-area">
        <div id="api-key-container">
            <input type="password" id="api-key" placeholder="ç²˜è´´ Key (sk-or-...)">
        </div>
        <div class="input-group">
            <textarea id="user-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            <button id="send-btn" onclick="runChat()">å‘é€</button>
        </div>
    </div>
</div>

<script>
    // é¡µé¢åŠ è½½é€»è¾‘
    window.addEventListener('load', () => {
        const savedKey = localStorage.getItem('deepSpaceKey');
        const keyContainer = document.getElementById('api-key-container');
        const keyInput = document.getElementById('api-key');

        if (savedKey) {
            keyInput.value = savedKey;
            keyContainer.style.display = 'none';
        } else {
            keyContainer.style.display = 'block';
        }
    });

    async function runChat() {
        const keyInput = document.getElementById('api-key');
        const textInput = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');
        const btn = document.getElementById('send-btn');
        const keyContainer = document.getElementById('api-key-container');

        const key = keyInput.value.trim();
        const text = textInput.value.trim();

        if (!key) { alert("è¯·å…ˆå¡«å†™ API Keyï¼"); return; }
        if (!text) return;

        // å­˜ Key
        localStorage.setItem('deepSpaceKey', key);
        keyContainer.style.display = 'none';

        addBubble('user', text);
        textInput.value = '';
        btn.disabled = true;

        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 10);

        try {
            const req = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + key,
                    "Content-Type": "application/json",
                    "HTTP-Referer": window.location.href,
                    "X-Title": "My AI Site"
                },
                body: JSON.stringify({
                    model: "nousresearch/hermes-3-llama-3.1-405b",
                    messages: [
                        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„ä¸­æ–‡AIåŠ©æ‰‹ã€‚" },
                        { role: "user", content: text }
                    ]
                })
            });

            if (!req.ok) throw new Error("Key æ— æ•ˆæˆ–ä½™é¢ä¸è¶³");
            
            const res = await req.json();
            const reply = res.choices[0].message.content;
            addBubble('ai', reply);

        } catch (err) {
            addBubble('ai', "âŒ å‡ºé”™: " + err.message);
            keyContainer.style.display = 'block';
        } finally {
            btn.disabled = false;
        }
    }

    function addBubble(role, text) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = 'msg ' + role;
        const avatar = role === 'user' ? '<div class="avatar">ğŸ‘¤</div>' : '<div class="avatar">ğŸ¤–</div>';
        div.innerHTML = avatar + '<div class="bubble">' + text + '</div>';
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function resetKey() {
        if(confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„ Key å—ï¼Ÿ')) {
            localStorage.removeItem('deepSpaceKey');
            document.getElementById('api-key').value = '';
            document.getElementById('api-key-container').style.display = 'block';
        }
    }

    // å›è½¦å‘é€
    document.getElementById('user-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            runChat();
        }
    });
</script>

</body>
</html>